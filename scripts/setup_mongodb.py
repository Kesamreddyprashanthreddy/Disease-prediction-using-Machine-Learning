"""
MongoDB Setup Helper Script
============================
Interactive script to help configure MongoDB authentication
"""

import os
import sys
from pathlib import Path

def create_streamlit_folder():
    """Create .streamlit folder if it doesn't exist"""
    streamlit_dir = Path(".streamlit")
    if not streamlit_dir.exists():
        streamlit_dir.mkdir()
        print("âœ… Created .streamlit folder")
    else:
        print("â„¹ï¸  .streamlit folder already exists")
    return streamlit_dir

def create_secrets_file(connection_string, database_name="medical_diagnosis_db"):
    """Create secrets.toml file with MongoDB configuration"""
    streamlit_dir = Path(".streamlit")
    secrets_file = streamlit_dir / "secrets.toml"
    
    content = f"""# MongoDB Configuration
# Generated by setup_mongodb.py

[mongodb]
# MongoDB connection string
connection_string = "{connection_string}"

# Database name
database = "{database_name}"

# Optional: Collection names (defaults will be used if not specified)
users_collection = "users"
"""
    
    with open(secrets_file, 'w') as f:
        f.write(content)
    
    print(f"âœ… Created {secrets_file}")
    return secrets_file

def test_mongodb_connection(connection_string):
    """Test MongoDB connection"""
    try:
        from pymongo import MongoClient
        from pymongo.errors import ConnectionFailure
        
        print("\nğŸ” Testing MongoDB connection...")
        client = MongoClient(connection_string, serverSelectionTimeoutMS=5000)
        
        # Test connection
        client.server_info()
        
        print("âœ… Successfully connected to MongoDB!")
        print(f"   Server version: {client.server_info()['version']}")
        
        client.close()
        return True
        
    except ImportError:
        print("âŒ pymongo not installed. Run: pip install pymongo")
        return False
    except ConnectionFailure:
        print("âŒ Failed to connect to MongoDB. Please check your connection string.")
        return False
    except Exception as e:
        print(f"âŒ Error: {str(e)}")
        return False

def install_requirements():
    """Install required packages"""
    print("\nğŸ“¦ Installing required packages...")
    os.system(f"{sys.executable} -m pip install -r requirements_mongodb.txt")
    print("âœ… Packages installed")

def main():
    """Main setup function"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                               â•‘
â•‘   ğŸ©º Disease Prediction System - MongoDB Setup              â•‘
â•‘                                                               â•‘
â•‘   This script will help you configure MongoDB               â•‘
â•‘   authentication for your medical diagnosis system          â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # Step 1: Check requirements
    print("\nğŸ“‹ Step 1: Checking requirements...")
    
    try:
        import pymongo
        import bcrypt
        import streamlit
        print("âœ… All required packages are installed")
    except ImportError as e:
        print(f"âš ï¸  Missing package: {str(e)}")
        response = input("\nWould you like to install required packages now? (y/n): ")
        if response.lower() == 'y':
            install_requirements()
        else:
            print("\nâŒ Setup cancelled. Please install requirements manually:")
            print("   pip install -r requirements_mongodb.txt")
            return
    
    # Step 2: Get MongoDB connection string
    print("\nğŸ” Step 2: MongoDB Connection Configuration")
    print("\nChoose your MongoDB setup:")
    print("1. MongoDB Atlas (Cloud)")
    print("2. Local MongoDB")
    print("3. I already have a connection string")
    
    choice = input("\nEnter your choice (1/2/3): ").strip()
    
    if choice == "1":
        print("\nğŸ“˜ MongoDB Atlas Setup:")
        print("   1. Visit: https://www.mongodb.com/cloud/atlas/register")
        print("   2. Create a free cluster")
        print("   3. Create a database user")
        print("   4. Whitelist your IP (0.0.0.0/0 for testing)")
        print("   5. Get connection string from 'Connect' â†’ 'Connect your application'")
        print("\n   Connection string format:")
        print("   mongodb+srv://username:password@cluster.mongodb.net/?retryWrites=true&w=majority")
        
        connection_string = input("\nğŸ“ Paste your MongoDB Atlas connection string: ").strip()
        
    elif choice == "2":
        print("\nğŸ’» Local MongoDB Setup:")
        print("   Default connection string for local MongoDB:")
        connection_string = "mongodb://localhost:27017/"
        print(f"   Using: {connection_string}")
        
        custom = input("\n   Use different connection string? (y/n): ").strip().lower()
        if custom == 'y':
            connection_string = input("   Enter connection string: ").strip()
    
    elif choice == "3":
        connection_string = input("\nğŸ“ Enter your MongoDB connection string: ").strip()
    
    else:
        print("âŒ Invalid choice. Setup cancelled.")
        return
    
    if not connection_string:
        print("âŒ No connection string provided. Setup cancelled.")
        return
    
    # Step 3: Database name
    print("\nğŸ“Š Step 3: Database Configuration")
    database_name = input("Enter database name (default: medical_diagnosis_db): ").strip()
    if not database_name:
        database_name = "medical_diagnosis_db"
    
    # Step 4: Test connection
    if not test_mongodb_connection(connection_string):
        print("\nâš ï¸  Connection test failed!")
        response = input("Continue anyway? (y/n): ").strip().lower()
        if response != 'y':
            print("âŒ Setup cancelled.")
            return
    
    # Step 5: Create configuration files
    print("\nğŸ“ Step 4: Creating configuration files...")
    
    streamlit_dir = create_streamlit_folder()
    secrets_file = create_secrets_file(connection_string, database_name)
    
    # Step 6: Security check
    print("\nğŸ”’ Step 5: Security Check")
    
    gitignore_path = Path(".gitignore")
    if gitignore_path.exists():
        with open(gitignore_path, 'r') as f:
            gitignore_content = f.read()
        
        if '.streamlit/secrets.toml' not in gitignore_content:
            print("âš ï¸  secrets.toml not in .gitignore")
            response = input("   Add to .gitignore? (y/n): ").strip().lower()
            if response == 'y':
                with open(gitignore_path, 'a') as f:
                    f.write("\n# Streamlit secrets\n.streamlit/secrets.toml\n")
                print("âœ… Added to .gitignore")
    else:
        print("âš ï¸  No .gitignore file found")
        response = input("   Create .gitignore? (y/n): ").strip().lower()
        if response == 'y':
            with open(gitignore_path, 'w') as f:
                f.write("# Streamlit secrets\n.streamlit/secrets.toml\n\n")
                f.write("# Python\n__pycache__/\n*.pyc\n*.pyo\n*.pyd\n")
                f.write("\n# Virtual Environment\nenv/\nvenv/\n")
                f.write("\n# Old databases\nusers.db\n")
            print("âœ… Created .gitignore")
    
    # Step 7: Summary
    print("\n" + "="*65)
    print("âœ… SETUP COMPLETE!")
    print("="*65)
    print("\nğŸ“‹ Summary:")
    print(f"   âœ“ Configuration file: {secrets_file}")
    print(f"   âœ“ Database: {database_name}")
    print(f"   âœ“ Connection: {'MongoDB Atlas' if 'mongodb+srv' in connection_string else 'Local MongoDB'}")
    
    print("\nğŸš€ Next Steps:")
    print("   1. Run the application:")
    print("      streamlit run app_mongodb.py")
    print("\n   2. Open your browser:")
    print("      http://localhost:8501")
    print("\n   3. Login with demo credentials:")
    print("      Username: demo_user")
    print("      Password: demo123")
    
    print("\nğŸ“š Documentation:")
    print("   â€¢ MONGODB_SETUP_GUIDE.md - Detailed setup guide")
    print("   â€¢ README_MONGODB_AUTH.md - Complete documentation")
    
    print("\nğŸ’¡ Tips:")
    print("   â€¢ Never commit secrets.toml to Git")
    print("   â€¢ Use strong passwords for production")
    print("   â€¢ Enable MongoDB authentication")
    print("   â€¢ Regular backups recommended")
    
    print("\n" + "="*65)
    
    # Step 8: Offer to run application
    response = input("\nWould you like to run the application now? (y/n): ").strip().lower()
    if response == 'y':
        print("\nğŸš€ Starting application...")
        os.system("streamlit run app_mongodb.py")
    else:
        print("\nğŸ‘‹ Setup complete! Run 'streamlit run app_mongodb.py' when ready.")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâŒ Setup cancelled by user.")
    except Exception as e:
        print(f"\nâŒ Error during setup: {str(e)}")
        print("\nPlease check the documentation and try again.")

